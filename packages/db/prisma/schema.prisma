// EDUverse Database Schema
// Prisma schema for all services

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// PLAYER SERVICE
// ============================================

model Player {
  id            String   @id @default(uuid())
  username      String   @unique
  email         String   @unique
  passwordHash  String
  avatar        String?
  
  // Class & Progression
  class         PlayerClass
  level         Int      @default(1)
  xp            BigInt   @default(0)
  powerScore    Int      @default(0)
  prestigeLevel Int      @default(0)
  ascensionRank Int      @default(0)
  
  // Attributes
  energy        Int      @default(100)
  stamina       Int      @default(100)
  focus         Int      @default(100)
  
  // Status
  rank          PlayerRank @default(NOVICE)
  titles        String[]
  reputation    Int      @default(0)
  trustScore    Float    @default(1.0)
  
  // Economy
  coins         BigInt   @default(0)
  crystals      Int      @default(0)
  
  // Social
  guildId       String?
  guild         Guild?   @relation(fields: [guildId], references: [id])
  
  // Relations
  skills        PlayerSkill[]
  achievements  PlayerAchievement[]
  badges        PlayerBadge[]
  inventory     InventoryItem[]
  pets          Pet[]
  stats         PlayerStats?
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastActiveAt  DateTime @default(now())
  
  @@index([username])
  @@index([email])
  @@index([level])
  @@index([powerScore])
  @@index([guildId])
}

enum PlayerClass {
  CODER
  DESIGNER
  ENGINEER
  ANALYST
}

enum PlayerRank {
  NOVICE
  APPRENTICE
  JOURNEYMAN
  EXPERT
  MASTER
  GRANDMASTER
  LEGEND
}

model PlayerSkill {
  id            String   @id @default(uuid())
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  skillId       String
  skillName     String
  xp            BigInt   @default(0)
  level         Int      @default(1)
  mastery       Int      @default(0) // 0-100
  
  unlockedAt    DateTime @default(now())
  lastPracticedAt DateTime @default(now())
  
  @@unique([playerId, skillId])
  @@index([playerId])
  @@index([skillId])
}

model PlayerAchievement {
  id            String   @id @default(uuid())
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  achievementId String
  unlockedAt    DateTime @default(now())
  
  @@unique([playerId, achievementId])
  @@index([playerId])
}

model PlayerBadge {
  id            String   @id @default(uuid())
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  badgeId       String
  obtainedAt    DateTime @default(now())
  
  @@unique([playerId, badgeId])
  @@index([playerId])
}

model InventoryItem {
  id            String   @id @default(uuid())
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  itemId        String
  itemName      String
  quantity      Int      @default(1)
  rarity        ItemRarity
  obtainedAt    DateTime @default(now())
  
  @@index([playerId])
  @@index([itemId])
}

enum ItemRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
  MYTHIC
}

model Pet {
  id            String   @id @default(uuid())
  playerId      String
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  petId         String
  name          String
  level         Int      @default(1)
  xp            BigInt   @default(0)
  rarity        ItemRarity
  equipped      Boolean  @default(false)
  obtainedAt    DateTime @default(now())
  
  @@index([playerId])
}

model PlayerStats {
  id                String   @id @default(uuid())
  playerId          String   @unique
  player            Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  totalXp           BigInt   @default(0)
  totalQuestsCompleted Int   @default(0)
  totalSkillsMastered Int    @default(0)
  totalMatches      Int      @default(0)
  winRate           Float    @default(0)
  averageScore      Float    @default(0)
  playTime          Int      @default(0) // minutes
  streak            Int      @default(0)
  longestStreak      Int      @default(0)
  
  updatedAt         DateTime @updatedAt
}

// ============================================
// QUEST ENGINE
// ============================================

model Quest {
  id            String   @id @default(uuid())
  name          String
  description   String
  type          QuestType
  difficulty    Difficulty
  
  // Requirements
  requiredLevel Int?
  requiredSkills String[]
  unlockCondition Json?
  
  // Rewards
  xpReward      BigInt
  coinReward    BigInt
  itemRewards   Json? // Array of {itemId, quantity, chance}
  
  // Metadata
  worldId       String?
  questChainId  String?
  isHidden      Boolean  @default(false)
  isRepeatable  Boolean  @default(false)
  timeLimit     Int?     // seconds
  
  // Relations
  completions   QuestCompletion[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([type])
  @@index([worldId])
  @@index([questChainId])
}

enum QuestType {
  DAILY
  WEEKLY
  STORY
  SIDE
  HIDDEN
  EVENT
  GUILD
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  MASTER
}

model QuestCompletion {
  id            String   @id @default(uuid())
  questId       String
  quest         Quest    @relation(fields: [questId], references: [id])
  
  playerId      String
  completedAt   DateTime @default(now())
  completionTime Int?    // seconds
  score         Int?
  
  @@unique([questId, playerId])
  @@index([playerId])
  @@index([questId])
}

// ============================================
// WORLD ENGINE
// ============================================

model World {
  id            String   @id @default(uuid())
  name          String
  description   String
  biome         Biome
  difficulty    Difficulty
  
  // Unlocking
  requiredLevel Int?
  requiredSkills String[]
  unlockConditions Json?
  
  // Content
  questChains   Json?   // Array of quest chain IDs
  dungeonIds    String[]
  raidBossId    String?
  
  // Metadata
  isEvent       Boolean  @default(false)
  eventStartDate DateTime?
  eventEndDate  DateTime?
  isTimeLimited Boolean  @default(false)
  maxPlayers    Int?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([biome])
  @@index([difficulty])
}

enum Biome {
  TUTORIAL
  FOREST
  DESERT
  OCEAN
  MOUNTAIN
  SPACE
  CYBER
  FANTASY
}

model Dungeon {
  id            String   @id @default(uuid())
  worldId       String
  name          String
  description   String
  difficulty    Difficulty
  
  minPlayers    Int      @default(1)
  maxPlayers    Int      @default(4)
  estimatedDuration Int  // minutes
  
  puzzles       Json     // Array of puzzle objects
  rewards       Json     // Reward structure
  
  unlockCondition Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([worldId])
}

model RaidBoss {
  id            String   @id @default(uuid())
  worldId       String
  name          String
  description   String
  difficulty    Difficulty
  
  minPlayers    Int      @default(4)
  maxPlayers    Int      @default(10)
  
  phases        Json     // Array of boss phases
  rewards       Json     // Reward structure
  health        BigInt
  currentHealth BigInt?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([worldId])
}

// ============================================
// GUILD ENGINE
// ============================================

model Guild {
  id            String   @id @default(uuid())
  name          String   @unique
  description   String?
  tag           String   @unique // 3-5 char tag
  avatar        String?
  
  leaderId      String
  level         Int      @default(1)
  xp            BigInt   @default(0)
  
  maxMembers    Int      @default(20)
  memberCount   Int      @default(0)
  
  // Relations
  members       Player[]
  guildQuests   GuildQuest[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([name])
  @@index([leaderId])
}

model GuildQuest {
  id            String   @id @default(uuid())
  guildId      String
  guild        Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  questId      String
  progress     Json     // Progress tracking
  completedAt  DateTime?
  
  @@index([guildId])
}

// ============================================
// ECONOMY ENGINE
// ============================================

model Transaction {
  id            String   @id @default(uuid())
  playerId      String
  
  type          TransactionType
  currency      Currency
  amount        BigInt
  
  itemId        String?
  itemName      String?
  
  metadata      Json?
  
  createdAt     DateTime @default(now())
  
  @@index([playerId])
  @@index([type])
  @@index([createdAt])
}

enum TransactionType {
  PURCHASE
  SALE
  REWARD
  CRAFT
  TRANSFER
  REFUND
}

enum Currency {
  COINS
  CRYSTALS
}

model MarketplaceListing {
  id            String   @id @default(uuid())
  sellerId      String
  
  itemId        String
  itemName      String
  quantity      Int
  price         BigInt
  currency      Currency
  
  status        ListingStatus @default(ACTIVE)
  
  createdAt     DateTime @default(now())
  soldAt       DateTime?
  
  @@index([sellerId])
  @@index([status])
  @@index([itemId])
}

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
  EXPIRED
}

// ============================================
// ARENA ENGINE
// ============================================

model Match {
  id            String   @id @default(uuid())
  type          MatchType
  status        MatchStatus
  
  players       String[] // Player IDs
  scores        Json     // {playerId: score}
  
  winnerId      String?
  duration      Int?     // seconds
  
  arenaId      String?
  tournamentId String?
  
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  
  @@index([status])
  @@index([type])
  @@index([tournamentId])
}

enum MatchType {
  RANKED
  CASUAL
  TOURNAMENT
  PRACTICE
}

enum MatchStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ABANDONED
}

model Tournament {
  id            String   @id @default(uuid())
  name          String
  type          TournamentType
  status        TournamentStatus
  
  maxParticipants Int
  currentParticipants Int @default(0)
  
  entryFee      BigInt?
  prizePool    BigInt   @default(0)
  
  startDate     DateTime
  endDate       DateTime?
  
  participants  String[] // Player IDs
  matches       Match[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([status])
  @@index([type])
}

enum TournamentType {
  SOLO
  TEAM
  GUILD
}

enum TournamentStatus {
  UPCOMING
  REGISTRATION
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
